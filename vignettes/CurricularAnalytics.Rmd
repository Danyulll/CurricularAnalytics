---
title: "CurricularAnalytics"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{CurricularAnalytics}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
bibliography: references.bib 
editor_options: 
  markdown: 
    wrap: 72
---

<!-- TODO: change vignette title -->

```{=html}
<script type="text/x-mathjax-config">
MathJax.Hub.Register.StartupHook("TeX Jax Ready",function () {
  MathJax.Hub.Insert(MathJax.InputJax.TeX.Definitions.macros,{
    cancel: ["Extension","cancel"],
    bcancel: ["Extension","cancel"],
    xcancel: ["Extension","cancel"],
    cancelto: ["Extension","cancel"]
  });
});
</script>
```
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Introduced by [@heileman2018curricular], Curricular Analytics (CA)
introduces a framework that allows one to leverage complex network
analysis when investigating curricula structure relating the ease with
which a student progresses through a curriculum with its structural
complexity. The package CurricularAnalytics provides an implementation
of the CA framework for use in R. Through it one may construct and
visualize curriculum graphs and investigate various metrics such as

-   Blocking Factor
-   Delay Factor
-   Centrality
-   Structural Complexity

# Background

## Introduction

CA identifies two primary components when investigating the effect
curricula has on students as they complete a degree: *structural
complexity* and *instructional complexity*. Structural complexity has to
do with how courses are ordered in sequence and more specifically how
requisite relationships between course orderings impact student success.
Instructional complexity refers to the quality of instructors, support
resources, etc. CA postulates that the complexity of a given curriculum
$c$ will be a function of these two complexities:
$$\Psi_c = f(\alpha_c,\gamma_c)$$ where

-   $\gamma_c=g(\bar{x}_c)$ represents the instructional complexity
    which is itself a function of a vector $\bar{x}_c$ containing
    instructional factors.
-   $\alpha_c = h(\bar{y}_c)$ represents the structural complexity which
    is itself a function of a vector $\bar{y}_c$ containing structural
    factors.

CA's main emphasis is in approximating $\alpha_c$ and altering curricula
to minimize structural complexity. For more reading on CA and its
applications see [@heileman2018curricular].

# Metrics

## Notation

Curricula are represented as directed acyclic graphs (DAGs). Nodes
represent courses and directed edges exist between nodes that hold pre-
or co-requisite relationships. Mathematically, for a curriculum $c$ that
hold $n$ courses we construct a *curriculum graph* $G_c=(V,E)$ where
each $v \in V = \{v_1,\dots,v_n\}$ represents a course and a directed
edge $(v_i, v_j) \in E$ exists if course $v_i$ must be completed
previous or in conjunction with $v_j$. Note no distinction is made
between a co- and pre-requisites.

Paths in a curriculum graph will be denoted as follows: a path
$p \in G_c = (V,E)$ is written $v_i \overset{p}{\rightsquigarrow} v_j$
where $v_i,v_j \in V$. A path is simply a sequence of vertices
$\langle v_i,\dots,v_j \rangle$ where if $v_x$ comes before $v_y$ then
$(v_x,v_y) \in E$. Additionally,
$\#(v_i \overset{p}{\rightsquigarrow} v_j)$ is used to represent the
number of nodes on a path.

## Delay Factor

The delay factor of a course is the longest path the nodes finds itself
on. More formally the delay factor of a node $v_k$ is given by

$$d_c(v_k)=\underset{i,j,l,m}{max}\left\{\#\left(v_i \overset{p_l}{\rightsquigarrow} v_k \overset{p_m}{\rightsquigarrow} v_j \right)\right\}$$
The delay factor of an entire curriculum graph $G_c$ is defined as

$$d(G_c)=\sum_{v_k \in V}d_c(v_k)$$

## Blocking Factor

Blocking factor quantifies when a failing a course would result in being
blocked from registering for future courses. More formally the blocking
factor of a node $v_i$ is defined as

$$b_c(v_i) = \sum_{v_j \in V} I(v_i,v_j)$$ where $I$ is the indicator
function:

$$=\begin{cases}1, & \text{if } v_i \rightsquigarrow v_j \\ 0, & \text{if }v_i \cancel{\rightsquigarrow} v_j\end{cases}$$
The blocking factor for an entire curriculum graph $G_c$ is defined as

$$b(G_c)=\sum_{v_i \in V} b_c(v_i)$$

## Centrality

A course is considered central if it has many requisite edges flowing in
and out of the node. More formally it is the number of long paths that
include the node. That is, consider a curriculum graph \eqn{G_c} and a
vertex $v_i$. A long path is a path that satisfies the following
conditions:

-   $v_i,v_j,v_k$ are distinct
-   $v_j \rightsquigarrow v_i \rightsquigarrow v_k$
-   $v_j$ is a source node (in-degree zero)
-   $v_k$ is a sink node (out-degree zero)

Let $P_{v_i}=\{p_1,p_2,\dots\}$ denote the set of all paths defined as
above. Then the centrality of a node $v_i$ is given by

$$q(v_i)=\sum^{|P_{v_i}|}_{l=1}\#(p_l)$$ More plainly this is the number
of paths containing $v_i$ of at least length 3 where $v_i$ is neither
source nor sink node.

## Structural Complexity

The structural complexity of a node $v_k$ is defined as a linear
combination of the node's delay and blocking factors. More formally

$$h(v_k) = d(v_k) + b(v_k)$$ The structural complexity of an entire
curriculum graph $G_c$ is defined as

$$h(G_c)=d(G_c)+b(G_c)=\sum_{v_k \in V} \left(d_c(v_k) + b_c(v_k)\right)$$

# Example Analysis

The following analyses present how one may use CurricularAnalytics to
analyze university curricula and inform curriculum revision and
creation. The analysis is conducted on the Data Science (DS) curriculum
found at the University of British Columbia - Okanagan (UBCO). As Data
Science is a rapidly evolving discipline the program has gone through
many iterations with several major overhauls having been implemented in
the last five years. The analysis investigates the current 2022 and 2023
DS majors, the 2022 DS minor, and the proposal of a math stream in the
2022 DS major.

## 2022/2023 DS Major


:::: {style="display: flex;"}

::: {}
Within the final years of the DS program at uBCO students have a wide
selection of DS-related elective credits. The rational behind this being
that DS is a very broad field which allows students to acquire key core
skills in their first two and a half years and then proceed to focus on
subject areas that interest them the most.

The result, however, is an increase in the variability of curriculum
graphs. Therefore, we propose to investigate the maximally and minimally
structurally complex graphs. This allows the analyst to place upper and
lower bounds on the structural complexity and see how degree pathways
interact at the extremes. Additionally, we omit any general electives as we wish to examine the core structure of the curriculum graph.

In CurricularAnalytics we store curriculum graphs in json files as suggested in [@hickman2017development]. One may construct these by hand or use curriculum_graph_to_json() after having made a graph using curriculum_graph_from_list(). 

:::

::: {}
![](figs/2022_DS_Major.png){width="400"}
:::

::::
```{r setup}
# Load library
library(CurricularAnalytics)

# Create curriculum graph object C
C <- curriculum_graph_from_json("C:\\Users\\danie\\OneDrive\\Desktop\\CurricularAnalytics\\data\\DS-Major-Max-2022-2023.json")

# Example creating C from node and edge lists:
node_list <- C$node_list
edge_list <- C$edge_list
C <- curriculum_graph_from_list(node_list, edge_list)
print(C$node_list)
print(C$edge_list)

# Plot curriculum graph
plot(C)
```

```{r}
# Example creating C from json file
C <- curriculum_graph_from_json("C:\\Users\\danie\\OneDrive\\Desktop\\CurricularAnalytics\\data\\DS-Major-Max-2022-2023.json")

# Plot curriculum graph
plot(C)
```

These plots are fully interactable allowing you to move nodes around and click on nodes to explore their values. At the top we see the total structural complexity, blocking factor, and delay factor. These metrics speak to the overall complexity of the curriculum graph. Clicking a node reveals its structural complexity (sc), centrality (cf), blocking factor (bf), and delay factor (df).

Let us first examine our maximally complex curriculum graph. The total structural complexity is 177, the total blocking factor is 74, and the total delay factor is 103. From here we wish to investigate further and the learn the set of course contributing the most to these metrics.

We first list the top course for each metric

```{r}
# Define helper function for printing courses
print_top_two_rows <- function(df, column) {
  ordered_df <- df[rev(order(df[[column]])), ]
  top_two <- head(ordered_df, 3)
  print(top_two)
}

# Print top two courses ordered by each metric
columns <- colnames(C$node_list[,c("bf","df","cf","sc")])
for (column in columns) {
  print(paste("Ordering by column:", column))
  print_top_two_rows(C$node_list, column)
}
```

The most central nodes are STAT 230 (73) and MATH 101 (65). From from visual inspection we can see STAT 230 is far too central as almost every edge to an advanced statistics or data science course has a path including STAT 230. STAT 230 is the primary introductory statistics course taken by students in the DS program. MATH 101 is Calculus 2 and since it serves as a rpe-requisite to STAT 230 it seems to take also take on the burden of being and overly central course. This suggests structural revision is need in STAT 230.

The courses with the greatest blocking factors are MATH 100 (17) and MATH 101 (14). These are Calculus 1 and 2 respectively. These inflated blocking factors are an unfortunate and common symptom of many STEM programs where Calculus 1 and 2 act as gateways into almost all course pathways and therefore block progression to many later courses. This often why failing these introductory courses is so detrimental to on-time graduation. This suggests increased resources towards MATH 100 and MATH 101 are warranted and if possible structural revision. Though this pattern is likely unavoidable and therefore so is structural intervention.

The courses with the greatest delay factors are MATH 100, MATH 101, MATH 200, STAT 230, DATA 311, STAT 303, STAT 401, STAT 403, DATA 410 with a value of 5. These courses find themselves a part of the longest pathways in the graph and their high delay factor speaks to the fact that if students wish to take the upper year STATs and DATA courses they must navigate a these very long pathways. We wish for students to graduate on-time and so these pathways are certainly areas that warrant restructuring.

The courses with the largest structural complexity are MATH 100 (22) and MATH 101 (19), again a common theme is having these introductory Calculus courses act as "weeder" courses and unfortunately within STEM curricula this leads to these course be the most frequent contributors to high structural complexity scores.

Through the examination of this graph we now have several areas of potential revision. STAT 230 certainly requires the greatest overhaul. When patterns such as STAT 230 are observed we often seek to split this course into two and divide up the requisite relationships. Furthermore courses that find themselves with high delay factors at the ends of pathways, such as DATA 410, could likely have their prerequisite consolidated into fewer courses and so this will be examined. Lastly MATH 100 and MATH 101 are a common symptom of STEM programs and so we will advise further resources be applied to these courses as opposed to any structural reforms.

Next we investigate the minimally complex curriculum graph. For the minimally complex graph we load the graph object from a CSV. This file format allows for specifying curriculum graphs in a far more readable fashion than JSON or node and edge lists. The CSV file must be of the following form:

- id: an integer id for the course
- label: a string with the name of the course
- term: an integer specifying what term the course is to be taken
- requisites: a list of all pre- and co-requisite course ids of the form 1;2;3;...

For example:

```{r, echo=FALSE}
library(knitr)
 disp <- data.frame(id = 1:5, label = c("MATH 100", "DATA 101", "MATH 101", "MATH 221", "STAT 230"), term = c(1,1,2,2,3), requisities = c(NA, NA, "1", "3", "3;2"))
kable(disp)
```

```{r}
# Example creating C from csvfile
C <- curriculum_graph_from_csv("C:\\Users\\danie\\OneDrive\\Desktop\\CurricularAnalytics\\data\\DS-Major-Min-2022-2023.csv")

# Plot curriculum graph
plot(C)
```

The total structural complexity is 147, the total blocking factor is 56, and the total delay factor is 91. This is quite a bit lower than the maximally complex graph and indicate a sizable range in structural complexity depending on student elective choice.

Listing the top courses for each metric once more:

```{r}
# Print top two courses ordered by each metric
columns <- colnames(C$node_list[,c("bf","df","cf","sc")])
for (column in columns) {
  print(paste("Ordering by column:", column))
  print_top_two_rows(C$node_list, column)
}
```
The most central nodes are STAT 230 (63), MATH 101 (42), MATH 221 (20). Once Again STAT 230 is the most central node and from visual inspection we see quite a few incoming and outgoing edges. Furthermore MATH 101 also reappears as the second most central node likely due to being a prerequisite to STAT 230. Interestingly MATH 221 finds itself being quite central in this curriculum. Perhaps further investigation into how we can reform connections including MATH 221.

The highest blocking factor courses are MATH 100 (14), MATH 101 (11), COSC 111 (7). We see no changes in the courses with the highest blocking factor.

The highest delay factor courses are MATH 100, MATH 101, STAT 230, DATA 311, STAT 400 with a a factor of 5. We see MATH 100, MATH 101, STAT 230, and DATA 311 reappearing on this list. This makes sense as these courses comprise one of the main pathways in the program of required courses.

The courses with the largest structural complexity are MATH 100 (19), MATH 101 (16), STAT 230 (11). MATH 100 and MATH 101 remain on this list. Again foundational calculus courses are difficult to restructure.

It may also be prudent to examine specifically which courses differ between the two graphs to better understand what elective choices contribute to changes in structural complexity.

```{r, echo=FALSE}
min_graph <- curriculum_graph_from_csv("C:\\Users\\danie\\OneDrive\\Desktop\\CurricularAnalytics\\data\\DS-Major-Min-2022-2023.csv")
max_graph <- curriculum_graph_from_json("C:\\Users\\danie\\OneDrive\\Desktop\\CurricularAnalytics\\data\\DS-Major-Max-2022-2023.json")

idx <- !(max_graph$node_list$label %in% min_graph$node_list$label)
kable(data.frame(Courses=max_graph$node_list$label[idx]))
```


The courses in the min graph that are not found in the max graph are:

```{r, echo=FALSE}
idx <- !(min_graph$node_list$label %in% max_graph$node_list$label)
kable(data.frame(Courses=min_graph$node_list$label[idx]))
```


With this we see some common courses appearing which further cements the need to revaluate their requisite relationships. We also see the addition of MATH 221 as being a central course and can been to alter its edges. Next we show how revisions suggested through a Curricular Analytics approach can be made and how these changes positively impact curriculum structure.


## 2023/2024 DS Major

In investigating the 2022 - 2023 DS Major curriculum graphs we identified several courses of interest: STAT 230 was far too central with a large majority of course pathways going through this node; DATA 410 had many prequisites contributing to a higher structural complexity; 

```{r}
# Create curriculum graph
C <- curriculum_graph_from_csv("C:\\Users\\danie\\OneDrive\\Desktop\\CurricularAnalytics\\data\\DS-Major-Max-2023-2024.csv")

# Plot curriculum graph
plot(C)
```

## DS Minor

Data Science minors are far more common at UBCO than the major. Therefore examination of the minor could prove impactful as the restructuring of the minor will affect more students. We explore the maximally and minimally complex minor curriculum graphs.

Minors are only 30 credits. In creating minor curriculum graphs we cannot simply sample 30 credits worth of permissible courses as this will exclude important prerequisite courses. We  wish to examine how courses flow into one another therefore we sample 30 credits of minor courses and represent these nodes as circles. We then add triangles for prerequisite courses that are not counted towards the minor but would still be required to take if the student wished to complete the minor counting courses.

Below we demonstrate how one can extract the igraph network curriculum graph object and have more control over the visualization using `visNetwork`. We begin with the maximally structurally complex graph.

```{r}
library(visNetwork)

# Create Curriculum Graph
C <- curriculum_graph_from_csv("C:\\Users\\danie\\OneDrive\\Desktop\\CurricularAnalytics\\data\\DS-Minor-Max.csv")

C$node_list <- C$node_list[order(C$node_list$term), ]

# Specify shape and group for each node
C$node_list$shape <- c(rep("circle",10),rep("triangle",16))
C$node_list$group <- c(rep("FALSE",10),rep("TRUE",16))

# Helper function to generate coordinates
generate_coords <- function(curriculum_graph) {
  coords <- matrix(ncol = 2)

  old_term <- 1
  idx <- -1
  for (term in curriculum_graph$node_list$term) {
    if (old_term != term) {
      idx <- 0
      old_term <- term
    } else{
      idx <- idx + 1
    }
    coords <- rbind(coords, c(term, idx))
  }

  coords <- stats::na.omit(coords)
  return(coords)
}

# Create fully customizable plot
visNetwork(
  C$node_list,
  C$edge_list,
  submain = paste(
    "Total Structural Complexity:",
    C$sc_total,
    "Total Blocking Factor:",
    C$bf_total,
    "Total Delay Factor:",
    C$df_total
  )
) %>%
  visEdges(arrows = "to") %>%
  visIgraphLayout(layout = "layout.norm", layoutMatrix = generate_coords(C)) %>%
  visEvents(
    selectNode = "function(properties) {
      alert(' sc: ' + this.body.data.nodes.get(properties.nodes[0]).sc + ' cf: ' + this.body.data.nodes.get(properties.nodes[0]).cf + ' bf: ' + this.body.data.nodes.get(properties.nodes[0]).bf + ' df: ' + this.body.data.nodes.get(properties.nodes[0]).df);}"
  )%>%
  visGroups(groupname = "TRUE", color = "red") %>%
  visGroups(groupname = "FALSE", color = "lightblue") %>%
  visLegend(width = 0.1, position = "right", main = "Is a Preqreq in the Minor")
```

Next is the minimally structurally complex graph.

```{r}
# Create Curriculum Graph
C <- curriculum_graph_from_csv("C:\\Users\\danie\\OneDrive\\Desktop\\CurricularAnalytics\\data\\DS-Minor-Min.csv")

C$node_list <- C$node_list[order(C$node_list$term), ]

# Specify shape and group for each node
C$node_list$shape <- c(rep("circle",9),rep("triangle",3))
C$node_list$group <- c(rep("FALSE",9),rep("TRUE",3))

visNetwork(
  C$node_list,
  C$edge_list,
  submain = paste(
    "Total Structural Complexity:",
    C$sc_total,
    "Total Blocking Factor:",
    C$bf_total,
    "Total Delay Factor:",
    C$df_total
  )
) %>%
  visEdges(arrows = "to") %>%
  visIgraphLayout(layout = "layout.norm", layoutMatrix = generate_coords(C)) %>%
  visEvents(
    selectNode = "function(properties) {
      alert(' sc: ' + this.body.data.nodes.get(properties.nodes[0]).sc + ' cf: ' + this.body.data.nodes.get(properties.nodes[0]).cf + ' bf: ' + this.body.data.nodes.get(properties.nodes[0]).bf + ' df: ' + this.body.data.nodes.get(properties.nodes[0]).df);}"
  )%>%
  visGroups(groupname = "TRUE", color = "red") %>%
  visGroups(groupname = "FALSE", color = "lightblue") %>%
  visLegend(width = 0.1, position = "right", main = "Is a Preqreq in the Minor")
```

## Creation of the DS Math Stream

Curricular Analytics may also be a powerful tool in inventing new programs. We demonstrate this through suggesting a math stream in the DS program. Currently many math electives are available to DS students, what would a DS major look like if we offered a math stream requiring all math electives?

MAX

```{r}
# Create curriculum graph
C <- curriculum_graph_from_csv("C:\\Users\\danie\\OneDrive\\Desktop\\CurricularAnalytics\\data\\DS-Major-Math-Max.csv")

# Plot curriculum graph
plot(C)
```

MIN

```{r}
# Create curriculum graph
C <- curriculum_graph_from_csv("C:\\Users\\danie\\OneDrive\\Desktop\\CurricularAnalytics\\data\\DS-Major-Math-Min.csv")

# Plot curriculum graph
plot(C)
```



# Conclusion

You can do cool stuff with curricular analytics

# References
